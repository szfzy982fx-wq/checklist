<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emlak Portf√∂y Y√∂neticisi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        #map { height: 300px; width: 100%; border-radius: 8px; margin-top: 10px; }
        .form-section-title { font-weight: 600; color: #495057; margin-bottom: 15px; border-bottom: 2px solid #e9ecef; padding-bottom: 5px; }
    </style>
</head>
<body>

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>üè† Emlak Portf√∂y Y√∂neticisi</h2>
        <div>
            <button class="btn btn-success btn-sm" onclick="exportData()">üíæ Yedeƒüi ƒ∞ndir</button>
            <input type="file" id="importFile" style="display:none" onchange="importData(this)">
            <button class="btn btn-warning btn-sm" onclick="document.getElementById('importFile').click()">üìÇ Yedek Y√ºkle</button>
        </div>
    </div>

    <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="pills-form-tab" data-bs-toggle="pill" data-bs-target="#pills-form" type="button">Yeni Kayƒ±t / D√ºzenle</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="pills-list-tab" data-bs-toggle="pill" data-bs-target="#pills-list" type="button" onclick="loadList()">Portf√∂y Listesi</button>
        </li>
    </ul>

    <div class="tab-content" id="pills-tabContent">
        
        <div class="tab-pane fade show active" id="pills-form" role="tabpanel">
            <form id="propertyForm">
                <input type="hidden" id="recordId"> <div class="card p-4">
                    <h5 class="form-section-title">üìù Temel Bilgiler</h5>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Ba≈ülƒ±k</label>
                            <input type="text" class="form-control" id="title" placeholder="√ñrn: Kepez √áamlƒ±bel 3+1" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Fiyat</label>
                            <input type="number" class="form-control" id="price" placeholder="2.500.000">
                        </div>
                         <div class="col-md-3">
                            <label class="form-label">Para Birimi</label>
                            <select class="form-select" id="currency">
                                <option value="TRY">‚Ç∫ TRY</option>
                                <option value="USD">$ USD</option>
                                <option value="EUR">‚Ç¨ EUR</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Kategori</label>
                            <select class="form-select" id="category">
                                <option>Daire</option>
                                <option>Villa</option>
                                <option>Arsa</option>
                                <option>ƒ∞≈üyeri</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Oda Sayƒ±sƒ±</label>
                            <select class="form-select" id="rooms">
                                <option>1+1</option>
                                <option>2+1</option>
                                <option>3+1</option>
                                <option>4+1</option>
                            </select>
                        </div>
                         <div class="col-md-4">
                            <label class="form-label">Metrekare (m¬≤)</label>
                            <input type="number" class="form-control" id="area" placeholder="120">
                        </div>
                    </div>
                </div>

                <div class="card p-4">
                    <div class="d-flex justify-content-between">
                        <h5 class="form-section-title">üìç Konum Bilgileri</h5>
                        <div>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="getLocation()">üìç Konumumu Bul</button>
                        </div>
                    </div>
                    
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">ƒ∞l</label>
                            <input type="text" class="form-control" id="city">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">ƒ∞l√ße</label>
                            <input type="text" class="form-control" id="district">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Mahalle</label>
                            <input type="text" class="form-control" id="neighborhood">
                        </div>
                         <div class="col-12">
                            <label class="form-label">A√ßƒ±k Adres / Sokak</label>
                            <input type="text" class="form-control" id="address">
                        </div>
                        <div class="col-12">
                            <div id="map"></div>
                            <small class="text-muted">Haritada konumu i≈üaretlemek i√ßin tƒ±klayƒ±n.</small>
                            <input type="hidden" id="lat">
                            <input type="hidden" id="lng">
                        </div>
                    </div>
                </div>

                <div class="card p-4">
                    <h5 class="form-section-title">‚ú® √ñzellikler</h5>
                    <div class="row">
                        <div class="col-md-4">
                            <h6>Dƒ±≈ü √ñzellikler</h6>
                            <div class="form-check"><input class="form-check-input feature-check" type="checkbox" value="Asans√∂r" id="f1"><label class="form-check-label" for="f1">Asans√∂r</label></div>
                            <div class="form-check"><input class="form-check-input feature-check" type="checkbox" value="Otopark" id="f2"><label class="form-check-label" for="f2">Otopark</label></div>
                            <div class="form-check"><input class="form-check-input feature-check" type="checkbox" value="G√ºvenlik" id="f3"><label class="form-check-label" for="f3">G√ºvenlik</label></div>
                        </div>
                        <div class="col-md-4">
                            <h6>ƒ∞√ß √ñzellikler</h6>
                            <div class="form-check"><input class="form-check-input feature-check" type="checkbox" value="Ebeveyn Banyosu" id="f4"><label class="form-check-label" for="f4">Ebeveyn Banyosu</label></div>
                            <div class="form-check"><input class="form-check-input feature-check" type="checkbox" value="Ankastre" id="f5"><label class="form-check-label" for="f5">Ankastre Set</label></div>
                            <div class="form-check"><input class="form-check-input feature-check" type="checkbox" value="Klima" id="f6"><label class="form-check-label" for="f6">Klima</label></div>
                        </div>
                         <div class="col-md-4">
                            <h6>Ula≈üƒ±m</h6>
                            <div class="form-check"><input class="form-check-input feature-check" type="checkbox" value="Metro" id="f7"><label class="form-check-label" for="f7">Metro</label></div>
                            <div class="form-check"><input class="form-check-input feature-check" type="checkbox" value="Otob√ºs" id="f8"><label class="form-check-label" for="f8">Otob√ºs Duraƒüƒ±</label></div>
                        </div>
                    </div>
                </div>

                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-primary btn-lg" onclick="saveRecord()">Kaydet</button>
                    <button type="button" class="btn btn-secondary" onclick="clearForm()">Temizle / Yeni Kayƒ±t</button>
                </div>
            </form>
        </div>

        <div class="tab-pane fade" id="pills-list" role="tabpanel">
            <div class="card p-4">
                <h5 class="form-section-title">üìã Kayƒ±tlƒ± Portf√∂yler</h5>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Ba≈ülƒ±k</th>
                                <th>Kategori</th>
                                <th>Fiyat</th>
                                <th>ƒ∞l/ƒ∞l√ße</th>
                                <th>ƒ∞≈ülemler</th>
                            </tr>
                        </thead>
                        <tbody id="recordListBody">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // --- 1. HARƒ∞TA AYARLARI ---
    var map = L.map('map').setView([36.8969, 30.7133], 13); // Ba≈ülangƒ±√ß Antalya
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    var marker;

    // Haritaya tƒ±klayƒ±nca marker koyma ve adres √ßekme
    map.on('click', function(e) {
        placeMarker(e.latlng.lat, e.latlng.lng);
        getAddressFromCoords(e.latlng.lat, e.latlng.lng);
    });

    function placeMarker(lat, lng) {
        if (marker) map.removeLayer(marker);
        marker = L.marker([lat, lng]).addTo(map);
        document.getElementById('lat').value = lat;
        document.getElementById('lng').value = lng;
    }

    // --- 2. KONUMU BUL VE ADRES √á√ñZ√úMLEME ---
    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                var lat = position.coords.latitude;
                var lng = position.coords.longitude;
                map.setView([lat, lng], 16);
                placeMarker(lat, lng);
                getAddressFromCoords(lat, lng); // Koordinatƒ± adrese √ßevir
            });
        } else { 
            alert("Tarayƒ±cƒ±nƒ±z konum servisini desteklemiyor.");
        }
    }

    // OpenStreetMap Nominatim API kullanarak koordinattan adres bulma
    async function getAddressFromCoords(lat, lng) {
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
            const data = await response.json();
            
            if(data.address) {
                document.getElementById('city').value = data.address.province || data.address.city || '';
                document.getElementById('district').value = data.address.town || data.address.district || data.address.borough || '';
                document.getElementById('neighborhood').value = data.address.neighbourhood || data.address.suburb || '';
                document.getElementById('address').value = data.address.road || '';
            }
        } catch (error) {
            console.error("Adres bulunamadƒ±:", error);
        }
    }

    // --- 3. VERƒ∞ KAYDETME VE OKUMA (CRUD) ---
    function saveRecord() {
        // Form verilerini topla
        const id = document.getElementById('recordId').value || Date.now().toString();
        
        // √ñzellikleri topla (Checkboxlar)
        let features = [];
        document.querySelectorAll('.feature-check:checked').forEach(c => features.push(c.value));

        const record = {
            id: id,
            title: document.getElementById('title').value,
            price: document.getElementById('price').value,
            currency: document.getElementById('currency').value,
            category: document.getElementById('category').value,
            rooms: document.getElementById('rooms').value,
            area: document.getElementById('area').value,
            city: document.getElementById('city').value,
            district: document.getElementById('district').value,
            neighborhood: document.getElementById('neighborhood').value,
            address: document.getElementById('address').value,
            lat: document.getElementById('lat').value,
            lng: document.getElementById('lng').value,
            features: features
        };

        // LocalStorage'dan mevcut verileri al
        let records = JSON.parse(localStorage.getItem('emlakRecords')) || [];
        
        // Eƒüer ID varsa g√ºncelle, yoksa yeni ekle
        const existingIndex = records.findIndex(r => r.id === id);
        if (existingIndex > -1) {
            records[existingIndex] = record;
        } else {
            records.push(record);
        }

        localStorage.setItem('emlakRecords', JSON.stringify(records));
        alert('Kayƒ±t Ba≈üarƒ±lƒ±! ‚úÖ');
        clearForm();
        loadList(); // Listeyi g√ºncelle
    }

    function loadList() {
        const tbody = document.getElementById('recordListBody');
        tbody.innerHTML = '';
        let records = JSON.parse(localStorage.getItem('emlakRecords')) || [];

        records.forEach(r => {
            let tr = `
                <tr>
                    <td>${r.title}</td>
                    <td><span class="badge bg-info text-dark">${r.category}</span></td>
                    <td>${r.price} ${r.currency}</td>
                    <td>${r.city} / ${r.district}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editRecord('${r.id}')">D√ºzenle</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteRecord('${r.id}')">Sil</button>
                        <button class="btn btn-sm btn-secondary" onclick="printRecord('${r.id}')">Belge</button>
                    </td>
                </tr>
            `;
            tbody.innerHTML += tr;
        });
    }

    function editRecord(id) {
        let records = JSON.parse(localStorage.getItem('emlakRecords')) || [];
        const r = records.find(item => item.id === id);
        if(r) {
            // Formu doldur
            document.getElementById('recordId').value = r.id;
            document.getElementById('title').value = r.title;
            document.getElementById('price').value = r.price;
            document.getElementById('currency').value = r.currency;
            document.getElementById('category').value = r.category;
            document.getElementById('rooms').value = r.rooms;
            document.getElementById('area').value = r.area;
            document.getElementById('city').value = r.city;
            document.getElementById('district').value = r.district;
            document.getElementById('neighborhood').value = r.neighborhood;
            document.getElementById('address').value = r.address;
            
            // Checkboxlarƒ± i≈üaretle
            document.querySelectorAll('.feature-check').forEach(c => c.checked = false);
            r.features.forEach(f => {
                let checkbox = document.querySelector(`.feature-check[value="${f}"]`);
                if(checkbox) checkbox.checked = true;
            });

            // Haritayƒ± g√ºncelle
            if(r.lat && r.lng) {
                placeMarker(r.lat, r.lng);
                map.setView([r.lat, r.lng], 16);
            }

            // Sekmeyi deƒüi≈ütir
            const triggerEl = document.querySelector('#pills-form-tab');
            const tab = new bootstrap.Tab(triggerEl);
            tab.show();
        }
    }

    function deleteRecord(id) {
        if(confirm('Bu kaydƒ± silmek istediƒüinize emin misiniz?')) {
            let records = JSON.parse(localStorage.getItem('emlakRecords')) || [];
            records = records.filter(r => r.id !== id);
            localStorage.setItem('emlakRecords', JSON.stringify(records));
            loadList();
        }
    }

    function clearForm() {
        document.getElementById('propertyForm').reset();
        document.getElementById('recordId').value = '';
        if(marker) map.removeLayer(marker);
    }

    // --- 4. YEDEKLEME VE GERƒ∞ Y√úKLEME ---
    function exportData() {
        const data = localStorage.getItem('emlakRecords');
        const blob = new Blob([data], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'emlak_yedek_' + new Date().toISOString().slice(0,10) + '.json';
        a.click();
    }

    function importData(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                localStorage.setItem('emlakRecords', JSON.stringify(data));
                alert("Yedek ba≈üarƒ±yla y√ºklendi!");
                loadList();
            } catch (err) {
                alert("Hatalƒ± dosya formatƒ±!");
            }
        };
        reader.readAsText(file);
    }
    
    // Belge G√∂r√ºnt√ºleme (Basit Versiyon)
    function printRecord(id) {
        let records = JSON.parse(localStorage.getItem('emlakRecords')) || [];
        const r = records.find(item => item.id === id);
        if(r) {
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>ƒ∞lan Detayƒ±</title>');
            printWindow.document.write('<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">');
            printWindow.document.write('</head><body><div class="container mt-5">');
            printWindow.document.write(`<h1>${r.title}</h1>`);
            printWindow.document.write(`<p><strong>Fiyat:</strong> ${r.price} ${r.currency}</p>`);
            printWindow.document.write(`<p><strong>Konum:</strong> ${r.city} / ${r.district} / ${r.neighborhood}</p>`);
            printWindow.document.write(`<p><strong>√ñzellikler:</strong> ${r.features.join(', ')}</p>`);
            printWindow.document.write('</div></body></html>');
            printWindow.document.close();
            printWindow.print();
        }
    }
</script>

</body>
</html>
