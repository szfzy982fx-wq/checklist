<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emlak PortfÃ¶y YÃ¶neticisi v3.1</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; }
        .nav-pills .nav-link.active { background-color: #0d6efd; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .form-section-title { font-weight: 600; color: #495057; border-bottom: 2px solid #e9ecef; padding-bottom: 5px; margin-bottom: 15px; margin-top: 15px; }
        #map { height: 300px; width: 100%; border-radius: 8px; }
        .preview-img { max-width: 100%; max-height: 250px; border-radius: 8px; display: none; margin-top: 10px; border: 2px solid #ddd; }
    </style>
</head>
<body>

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-primary fw-bold">ğŸ  PortfÃ¶y YÃ¶neticisi v3.1</h2>
        <div>
            <button class="btn btn-outline-success btn-sm" onclick="exportData()">ğŸ’¾ YedeÄŸi Ä°ndir</button>
            <input type="file" id="importFile" style="display:none" onchange="importData(this)">
            <button class="btn btn-outline-warning btn-sm" onclick="document.getElementById('importFile').click()">ğŸ“‚ Yedek YÃ¼kle</button>
        </div>
    </div>

    <ul class="nav nav-pills mb-4 nav-justified" id="mainTab" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-identity">1. Kimlik</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-tech">2. Teknik & Tapu</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-loc" onclick="resizeMap()">3. Konum</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-features">4. Ã–zellikler</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-media">5. Medya</button></li>
        <li class="nav-item"><button class="nav-link bg-dark text-white" data-bs-toggle="pill" data-bs-target="#tab-list" onclick="loadList()">ğŸ“‹ Liste & PaylaÅŸ</button></li>
    </ul>

    <div class="tab-content">
        
        <div class="tab-pane fade show active" id="tab-identity">
            <form id="emlakForm">
                <input type="hidden" id="recordId">
                <div class="card p-4">
                    <h5 class="form-section-title">Temel Bilgiler</h5>
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label fw-bold">Ä°lan BaÅŸlÄ±ÄŸÄ±</label>
                            <input type="text" class="form-control" id="title" placeholder="Ã–rn: Denize SÄ±fÄ±r LÃ¼ks Daire" required>
                        </div>
                        <div class="col-12">
                            <label class="form-label">AÃ§Ä±klama</label>
                            <textarea class="form-control" id="desc" rows="3"></textarea>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Fiyat</label>
                            <input type="text" class="form-control" id="price" onkeyup="formatCurrency(this)" placeholder="0">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Birim</label>
                            <select class="form-select" id="currency">
                                <option value="TL">â‚º TL</option>
                                <option value="USD">$ USD</option>
                                <option value="EUR">â‚¬ EUR</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Ä°lan TÃ¼rÃ¼</label>
                            <select class="form-select" id="adType">
                                <option>SatÄ±lÄ±k</option>
                                <option>KiralÄ±k</option>
                                <option>Devren</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Kategori</label>
                            <select class="form-select" id="propType">
                                <option>Daire</option>
                                <option>Villa</option>
                                <option>Loft</option>
                                <option>MÃ¼stakil</option>
                                <option>Arsa</option>
                                <option>Tarla</option>
                                <option>Ä°ÅŸyeri</option>
                                <option>Fabrika</option>
                            </select>
                        </div>
                    </div>
                </div>
        </div>

        <div class="tab-pane fade" id="tab-tech">
            <div class="card p-4">
                <h5 class="form-section-title">ğŸ“ Teknik Detaylar</h5>
                <div class="row g-3">
                    <div class="col-md-3"><label>BrÃ¼t mÂ²</label><input type="number" class="form-control" id="grossM2"></div>
                    <div class="col-md-3"><label>Net mÂ²</label><input type="number" class="form-control" id="netM2"></div>
                    
                    <div class="col-md-3">
                        <label>Oda SayÄ±sÄ±</label>
                        <select class="form-select" id="rooms">
                            <option>StÃ¼dyo (1+0)</option>
                            <option>1+1</option><option>1.5+1</option>
                            <option>2+0</option><option>2+1</option><option>2.5+1</option><option>2+2</option>
                            <option>3+0</option><option>3+1</option><option>3.5+1</option><option>3+2</option>
                            <option>4+0</option><option>4+1</option><option>4.5+1</option><option>4+2</option>
                            <option>5+1</option><option>5+2</option><option>6+1</option><option>6+2</option>
                        </select>
                    </div>

                    <div class="col-md-3"><label>Bina YaÅŸÄ±</label>
                        <select class="form-select" id="age">
                            <option>0 (Yeni)</option><option>1-5</option><option>5-10</option><option>11-20</option><option>21+</option>
                        </select>
                    </div>
                    
                    <div class="col-md-3"><label>BulunduÄŸu Kat</label><input type="text" class="form-control" id="floorCurr"></div>
                    <div class="col-md-3"><label>Kat SayÄ±sÄ±</label><input type="number" class="form-control" id="floorTotal"></div>

                    <div class="col-md-3"><label>Banyo SayÄ±sÄ±</label><input type="number" class="form-control" id="bath" value="1"></div>
                    <div class="col-md-3"><label>WC SayÄ±sÄ±</label><input type="number" class="form-control" id="wc" value="1"></div>
                    <div class="col-md-3"><label>Balkon SayÄ±sÄ±</label><input type="number" class="form-control" id="balcony" value="1"></div>

                    <div class="col-md-3">
                        <label>YapÄ± Tipi</label>
                        <select class="form-select" id="structureType">
                            <option>Betonarme</option>
                            <option>Ã‡elik</option>
                            <option>AhÅŸap</option>
                            <option>YÄ±ÄŸma</option>
                        </select>
                    </div>

                    <div class="col-md-3"><label>IsÄ±tma</label>
                        <select class="form-select" id="heating">
                            <option>Klima</option><option>Kombi</option><option>Merkezi</option>
                            <option>Merkezi (Pay Ã–lÃ§er)</option><option>Yerden IsÄ±tma</option>
                            <option>Jeotermal</option><option>Soba</option><option>Yok</option>
                        </select>
                    </div>
                </div>

                <h5 class="form-section-title mt-4">ğŸ“œ Tapu & Yasal Durum</h5>
                <div class="row g-3">
                    <div class="col-md-3"><label>Ada No</label><input type="number" class="form-control" id="adaNo"></div>
                    <div class="col-md-3"><label>Parsel No</label><input type="number" class="form-control" id="parselNo"></div>
                    
                    <div class="col-md-3">
                        <label>KullanÄ±m Durumu</label>
                        <select class="form-select" id="usageStatus">
                            <option>BoÅŸ</option>
                            <option>KiracÄ±lÄ±</option>
                            <option>MÃ¼lk Sahibi</option>
                        </select>
                    </div>

                    <div class="col-md-3">
                        <label>Tapu Durumu</label>
                        <select class="form-select" id="tapuStatus">
                            <option>Kat MÃ¼lkiyeti</option>
                            <option>Kat Ä°rtifakÄ±</option>
                            <option>Arsa PaylÄ±</option>
                            <option>MÃ¼stakil Tapu</option>
                            <option>Hisseli</option>
                            <option>Zilliyet</option>
                            <option>Ä°skan Yok</option>
                            <option>Ä°skan BaÅŸvurusu YapÄ±ldÄ±</option>
                        </select>
                    </div>
                </div>

                <h5 class="form-section-title mt-4">ğŸ’° Finansal Bilgiler</h5>
                <div class="row g-3">
                    <div class="col-md-3"><label>Krediye Uygun?</label>
                        <select class="form-select" id="credit"><option>Evet</option><option>HayÄ±r</option></select>
                    </div>
                    <div class="col-md-3"><label>Takas?</label>
                        <select class="form-select" id="swap"><option>HayÄ±r</option><option>Evet</option></select>
                    </div>
                    <div class="col-md-3"><label>Kira Getirisi (TL)</label><input type="text" class="form-control" id="rentalIncome" onkeyup="formatCurrency(this)"></div>
                    <div class="col-md-3"><label>Aidat (TL)</label><input type="text" class="form-control" id="dues" onkeyup="formatCurrency(this)"></div>
                    <div class="col-md-3"><label>Devren?</label>
                        <select class="form-select" id="devren"><option>HayÄ±r</option><option>Evet</option></select>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-loc">
            <div class="card p-4">
                <div class="d-flex justify-content-between mb-3">
                    <h5>Konum Bilgileri</h5>
                    <button type="button" class="btn btn-primary btn-sm" onclick="getLocation()">ğŸ“ Konumumu Bul</button>
                </div>
                <div class="row g-2">
                    <div class="col-md-4"><input type="text" class="form-control" id="city" placeholder="Ä°l"></div>
                    <div class="col-md-4"><input type="text" class="form-control" id="district" placeholder="Ä°lÃ§e"></div>
                    <div class="col-md-4"><input type="text" class="form-control" id="neighborhood" placeholder="Mahalle"></div>
                    <div class="col-12"><div id="map"></div></div>
                    <input type="hidden" id="lat"><input type="hidden" id="lng">
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-features">
            <div class="card p-4">
                <h6 class="form-section-title">ğŸ§­ Cephe ve Manzara</h6>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="fw-bold d-block mb-2">Cephe</label>
                        <div class="btn-group" role="group">
                            <input type="checkbox" class="btn-check facade-check" id="f_kuzey" value="Kuzey" autocomplete="off"><label class="btn btn-outline-secondary" for="f_kuzey">Kuzey</label>
                            <input type="checkbox" class="btn-check facade-check" id="f_guney" value="GÃ¼ney" autocomplete="off"><label class="btn btn-outline-secondary" for="f_guney">GÃ¼ney</label>
                            <input type="checkbox" class="btn-check facade-check" id="f_dogu" value="DoÄŸu" autocomplete="off"><label class="btn btn-outline-secondary" for="f_dogu">DoÄŸu</label>
                            <input type="checkbox" class="btn-check facade-check" id="f_bati" value="BatÄ±" autocomplete="off"><label class="btn btn-outline-secondary" for="f_bati">BatÄ±</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                         <label class="fw-bold d-block mb-2">Manzara</label>
                         <div class="row">
                             <div class="col-6"><div class="form-check"><input class="form-check-input view-check" type="checkbox" value="Deniz"><label>Deniz</label></div></div>
                             <div class="col-6"><div class="form-check"><input class="form-check-input view-check" type="checkbox" value="DoÄŸa"><label>DoÄŸa</label></div></div>
                             <div class="col-6"><div class="form-check"><input class="form-check-input view-check" type="checkbox" value="Åehir"><label>Åehir</label></div></div>
                         </div>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-md-4">
                        <h6 class="form-section-title">ğŸ  Ä°Ã§ Ã–zellikler</h6>
                        <div class="form-check"><input class="form-check-input feat-in" type="checkbox" value="Ã‡elik KapÄ±"><label>Ã‡elik KapÄ±</label></div>
                        <div class="form-check"><input class="form-check-input feat-in" type="checkbox" value="DuÅŸakabin"><label>DuÅŸakabin</label></div>
                        <div class="form-check"><input class="form-check-input feat-in" type="checkbox" value="Ebeveyn Banyosu"><label>Ebeveyn Banyosu</label></div>
                        <div class="form-check"><input class="form-check-input feat-in" type="checkbox" value="Ankastre Set"><label>Ankastre Set</label></div>
                    </div>
                    <div class="col-md-4">
                        <h6 class="form-section-title">ğŸ¢ DÄ±ÅŸ & Site</h6>
                        <div class="form-check"><input class="form-check-input feat-out" type="checkbox" value="AsansÃ¶r"><label>AsansÃ¶r</label></div>
                        <div class="form-check"><input class="form-check-input feat-out" type="checkbox" value="Otopark"><label>Otopark</label></div>
                        <div class="form-check"><input class="form-check-input feat-out" type="checkbox" value="GÃ¼venlik"><label>GÃ¼venlik</label></div>
                        <div class="form-check"><input class="form-check-input feat-out" type="checkbox" value="Havuz"><label>Havuz</label></div>
                    </div>
                    <div class="col-md-4">
                        <h6 class="form-section-title">ğŸ“ Muhit & UlaÅŸÄ±m</h6>
                        <div class="form-check"><input class="form-check-input feat-loc" type="checkbox" value="Metroya YakÄ±n"><label>Metroya YakÄ±n</label></div>
                        <div class="form-check"><input class="form-check-input feat-loc" type="checkbox" value="OtobÃ¼s DuraÄŸÄ±"><label>OtobÃ¼s DuraÄŸÄ±</label></div>
                        <div class="form-check"><input class="form-check-input feat-loc" type="checkbox" value="Market"><label>Market / AVM</label></div>
                        <div class="form-check"><input class="form-check-input feat-loc" type="checkbox" value="Okul"><label>Okul</label></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-media">
            <div class="card p-4 text-center">
                <h5>ğŸ“¸ Vitrin FotoÄŸrafÄ±</h5>
                <div class="alert alert-info small">FotoÄŸraflar oturum sÃ¼resince gÃ¶rÃ¼nÃ¼r. Metin bilgileriniz kalÄ±cÄ± olarak kaydedilir.</div>
                <input type="file" class="form-control" id="photoInput" accept="image/*" onchange="previewPhoto()">
                <img id="photoPreview" class="preview-img mx-auto">
                <input type="hidden" id="photoBase64">
            </div>
            <div class="d-grid gap-2 mt-4">
                <button type="button" class="btn btn-success btn-lg" onclick="saveRecord()">âœ… KAYDET</button>
                <button type="button" class="btn btn-secondary" onclick="clearForm()">Formu Temizle</button>
            </div>
        </div>
        </form>

        <div class="tab-pane fade" id="tab-list">
            <div class="card p-3">
                <h5 class="mb-3">ğŸ“‹ KayÄ±tlÄ± PortfÃ¶yler</h5>
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>GÃ¶rsel</th>
                                <th>BaÅŸlÄ±k</th>
                                <th>Fiyat</th>
                                <th>Konum</th>
                                <th style="width: 180px;">Ä°ÅŸlemler</th>
                            </tr>
                        </thead>
                        <tbody id="listBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="viewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewTitle">Ä°lan DetayÄ±</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="viewBody"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // --- (A) Rakam Basamaklama Fonksiyonu ---
    function formatCurrency(input) {
        // Sadece rakamlarÄ± al
        let value = input.value.replace(/\D/g, '');
        // Binlik ayracÄ± ekle (1.000.000)
        input.value = value.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    let sessionImages = {}; 

    // --- HARÄ°TA ---
    var map = L.map('map').setView([39.92, 32.85], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    var marker;

    function resizeMap() { setTimeout(() => { map.invalidateSize(); }, 200); }

    map.on('click', function(e) {
        setMarker(e.latlng.lat, e.latlng.lng);
        fetchAddress(e.latlng.lat, e.latlng.lng);
    });

    function setMarker(lat, lng) {
        if(marker) map.removeLayer(marker);
        marker = L.marker([lat, lng]).addTo(map);
        document.getElementById('lat').value = lat;
        document.getElementById('lng').value = lng;
    }

    function getLocation() {
        if(navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(p => {
                map.setView([p.coords.latitude, p.coords.longitude], 16);
                setMarker(p.coords.latitude, p.coords.longitude);
                fetchAddress(p.coords.latitude, p.coords.longitude);
            });
        }
    }

    async function fetchAddress(lat, lng) {
        try {
            let res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
            let data = await res.json();
            if(data.address) {
                document.getElementById('city').value = data.address.province || data.address.city || '';
                document.getElementById('district').value = data.address.town || data.address.district || '';
                document.getElementById('neighborhood').value = data.address.suburb || data.address.neighbourhood || '';
            }
        } catch(e) {}
    }

    // --- FOTOÄRAF ---
    function previewPhoto() {
        const file = document.getElementById('photoInput').files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('photoPreview').src = e.target.result;
                document.getElementById('photoPreview').style.display = 'block';
                document.getElementById('photoBase64').value = e.target.result;
            }
            reader.readAsDataURL(file);
        }
    }

    // --- CRUD Ä°ÅLEMLERÄ° ---
    function getVal(id) { return document.getElementById(id).value; }
    function setVal(id, v) { document.getElementById(id).value = v || ''; }
    function getChecks(cls) { return [...document.querySelectorAll('.'+cls+':checked')].map(c=>c.value); }

    function saveRecord() {
        const id = document.getElementById('recordId').value || 'ID'+Date.now();
        
        const record = {
            id,
            title: getVal('title'), desc: getVal('desc'), price: getVal('price'), currency: getVal('currency'),
            adType: getVal('adType'), propType: getVal('propType'),
            grossM2: getVal('grossM2'), netM2: getVal('netM2'), 
            rooms: getVal('rooms'), age: getVal('age'),
            floorCurr: getVal('floorCurr'), floorTotal: getVal('floorTotal'), 
            
            // Yeni Eklenen Alanlar
            bath: getVal('bath'), wc: getVal('wc'), balcony: getVal('balcony'), structureType: getVal('structureType'),
            heating: getVal('heating'),
            
            adaNo: getVal('adaNo'), parselNo: getVal('parselNo'), tapuStatus: getVal('tapuStatus'), usageStatus: getVal('usageStatus'),
            credit: getVal('credit'), swap: getVal('swap'), rentalIncome: getVal('rentalIncome'), devren: getVal('devren'), dues: getVal('dues'),
            
            city: getVal('city'), district: getVal('district'), neighborhood: getVal('neighborhood'),
            lat: getVal('lat'), lng: getVal('lng'),
            
            facade: getChecks('facade-check'),
            views: getChecks('view-check'),
            featIn: getChecks('feat-in'), featOut: getChecks('feat-out'), featLoc: getChecks('feat-loc')
        };

        const photoData = document.getElementById('photoBase64').value;
        if(photoData) sessionImages[id] = photoData;

        let db = JSON.parse(localStorage.getItem('emlakPortfoyDB')) || [];
        const idx = db.findIndex(r => r.id === id);
        if(idx > -1) db[idx] = record; else db.push(record);
        
        localStorage.setItem('emlakPortfoyDB', JSON.stringify(db));
        alert('KayÄ±t BaÅŸarÄ±lÄ±! âœ…');
        clearForm();
        loadList();
    }

    function loadList() {
        const tbody = document.getElementById('listBody');
        tbody.innerHTML = '';
        let db = JSON.parse(localStorage.getItem('emlakPortfoyDB')) || [];

        db.forEach(r => {
            let imgData = sessionImages[r.id];
            let thumb = imgData ? `<img src="${imgData}" style="width:50px; height:40px; object-fit:cover; border-radius:4px;">` : 'ğŸ“„';
            
            let row = `<tr>
                <td>${thumb}</td>
                <td><strong>${r.title}</strong><br><small class="text-muted">${r.adType} ${r.propType}</small></td>
                <td>${r.price} ${r.currency}</td>
                <td>${r.city}/${r.district}</td>
                <td>
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-info text-white" onclick="viewRecord('${r.id}')">ğŸ‘ï¸</button>
                        <button class="btn btn-sm btn-primary" onclick="editRecord('${r.id}')">âœï¸</button>
                        <button class="btn btn-sm btn-success" onclick="shareRecord('${r.id}')">ğŸ“¤</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteRecord('${r.id}')">ğŸ—‘ï¸</button>
                    </div>
                </td>
            </tr>`;
            tbody.innerHTML += row;
        });
    }

    function viewRecord(id) {
        let db = JSON.parse(localStorage.getItem('emlakPortfoyDB')) || [];
        let r = db.find(x => x.id === id);
        if(!r) return;

        document.getElementById('viewTitle').innerText = r.title;
        let imgData = sessionImages[r.id];
        let photoHtml = imgData ? `<img src="${imgData}" class="img-fluid rounded mb-3" style="max-height:300px;">` : '';
        
        let html = `
            ${photoHtml}
            <div class="row">
                <div class="col-6"><strong>Fiyat:</strong> ${r.price} ${r.currency}</div>
                <div class="col-6"><strong>Konum:</strong> ${r.city}/${r.district}</div>
                <div class="col-12"><hr></div>
                <div class="col-6"><strong>Oda:</strong> ${r.rooms}</div>
                <div class="col-6"><strong>YapÄ±:</strong> ${r.structureType || '-'}</div>
                <div class="col-6"><strong>Banyo/WC:</strong> ${r.bath} / ${r.wc}</div>
                <div class="col-6"><strong>IsÄ±tma:</strong> ${r.heating}</div>
                <div class="col-6"><strong>KullanÄ±m:</strong> ${r.usageStatus}</div>
                <div class="col-6"><strong>Tapu:</strong> ${r.tapuStatus}</div>
                <div class="col-12"><hr></div>
                <div class="col-12"><strong>Ã–zellikler:</strong><br>
                ${[...r.facade, ...r.views, ...r.featIn, ...r.featOut].join(', ')}</div>
            </div>
        `;
        document.getElementById('viewBody').innerHTML = html;
        new bootstrap.Modal(document.getElementById('viewModal')).show();
    }

    function shareRecord(id) {
        let db = JSON.parse(localStorage.getItem('emlakPortfoyDB')) || [];
        let r = db.find(x => x.id === id);
        if(!r) return;

        let text = `ğŸ  *${r.title}*\n` +
                   `ğŸ“ ${r.city} / ${r.district} / ${r.neighborhood}\n` +
                   `ğŸ’° *Fiyat:* ${r.price} ${r.currency}\n` +
                   `ğŸ“ *Detay:* ${r.propType}, ${r.rooms}, ${r.grossM2}mÂ²\n` +
                   `ğŸ› *Banyo/WC:* ${r.bath} Banyo, ${r.wc} WC, ${r.balcony} Balkon\n` +
                   `ğŸ—ï¸ *YapÄ±/IsÄ±tma:* ${r.structureType}, ${r.heating}\n` +
                   `ğŸ“œ *Tapu:* ${r.tapuStatus} (${r.usageStatus})\n` +
                   `âœ¨ *Ã–zellikler:* ${r.featIn.slice(0,3).join(', ')}...\n` +
                   `ğŸ“ Detaylar iÃ§in arayÄ±nÄ±z!`;

        navigator.clipboard.writeText(text).then(() => {
            alert("Ä°lan bilgileri kopyalandÄ±! WhatsApp'a yapÄ±ÅŸtÄ±rabilirsin. ğŸ“‹");
        });
    }

    function editRecord(id) {
        let db = JSON.parse(localStorage.getItem('emlakPortfoyDB')) || [];
        let r = db.find(x => x.id === id);
        if(!r) return;

        let trigger = new bootstrap.Tab(document.querySelector('#mainTab button[data-bs-target="#tab-identity"]'));
        trigger.show();

        document.getElementById('recordId').value = r.id;
        
        setVal('title', r.title); setVal('desc', r.desc); setVal('price', r.price); setVal('currency', r.currency);
        setVal('adType', r.adType); setVal('propType', r.propType);
        setVal('grossM2', r.grossM2); setVal('netM2', r.netM2); setVal('rooms', r.rooms); setVal('age', r.age);
        setVal('floorCurr', r.floorCurr); setVal('floorTotal', r.floorTotal); 
        
        // Yeni AlanlarÄ± Doldur
        setVal('bath', r.bath); setVal('wc', r.wc); setVal('balcony', r.balcony); 
        setVal('structureType', r.structureType); setVal('heating', r.heating);
        setVal('usageStatus', r.usageStatus); setVal('tapuStatus', r.tapuStatus);
        
        setVal('adaNo', r.adaNo); setVal('parselNo', r.parselNo);
        setVal('credit', r.credit); setVal('swap', r.swap); setVal('rentalIncome', r.rentalIncome); 
        setVal('devren', r.devren); setVal('dues', r.dues);
        setVal('city', r.city); setVal('district', r.district); setVal('neighborhood', r.neighborhood);
        setVal('lat', r.lat); setVal('lng', r.lng);

        document.querySelectorAll('input[type=checkbox]').forEach(c => c.checked = false);
        [...r.facade, ...r.views, ...r.featIn, ...r.featOut, ...r.featLoc].forEach(val => {
            let el = document.querySelector(`input[value="${val}"]`);
            if(el) el.checked = true;
        });
        
        if(sessionImages[r.id]){
            document.getElementById('photoPreview').src = sessionImages[r.id];
            document.getElementById('photoPreview').style.display = 'block';
            document.getElementById('photoBase64').value = sessionImages[r.id];
        }
    }

    function deleteRecord(id) {
        if(confirm('Silmek istediÄŸine emin misin?')) {
            let db = JSON.parse(localStorage.getItem('emlakPortfoyDB')) || [];
            db = db.filter(x => x.id !== id);
            localStorage.setItem('emlakPortfoyDB', JSON.stringify(db));
            delete sessionImages[id];
            loadList();
        }
    }

    function clearForm() {
        document.getElementById('emlakForm').reset();
        document.getElementById('recordId').value = '';
        document.getElementById('photoPreview').style.display = 'none';
        document.getElementById('photoBase64').value = '';
        if(marker) map.removeLayer(marker);
    }
    
    function exportData() {
        let data = localStorage.getItem('emlakPortfoyDB');
        let blob = new Blob([data], {type: 'application/json'});
        let a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'emlak_yedek.json';
        a.click();
    }
    function importData(input) {
        let reader = new FileReader();
        reader.onload = e => {
            localStorage.setItem('emlakPortfoyDB', JSON.stringify(JSON.parse(e.target.result)));
            loadList(); alert('YÃ¼klendi!');
        };
        reader.readAsText(input.files[0]);
    }
</script>
</body>
</html>
